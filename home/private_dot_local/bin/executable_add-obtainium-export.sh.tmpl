{{- template "bash-shebang" . -}}

set -e

files="/{{- template "storage/internal" . -}}/.obtainium/obtainium-export-*.json"
if ! ls $files 1> /dev/null 2>&1; then
    echo "No Obtainium export files found."
fi

newest_file=$(ls -t $files 2>/dev/null | head -n 1)
target_file="$HOME/.config/dev.imranr.obtainium/obtainium-export.json"
if ! diff -q "$newest_file" "$target_file" > /dev/null; then
    mv "$newest_file" "$target_file"
else
    echo "The .config Obtainium export file is unchanged."
    exit 1
fi

chezmoi verify "$target_file"
if [ $? -eq 1 ]; then
    echo "The Obtainium export file has changed. Do you want to add it to chezmoi and Git? (y/n)"
    read -r git_add
    if [[ "$git_add" == "y" || "$git_add" == "Y" ]]; then
        echo "Please enter a Git commit message:"
        read -r commit_message
        chezmoi add "$target_file"
        source_file=$(chezmoi source-path "$target_file")
        git add "$source_file"
        git commit -m "$commit_message"
    else
        echo "The new Obtainium export file not added to chezmoi and Git."
        exit 1
    fi
else
    echo "The chezmoi Obtainium export file is unchanged."
    exit 1
fi

rm -f "$files"
{{- if contains "android" .osid -}}
#!{{- lookPath "bash" }}

{{- $storage := output "bash" "-c" (printf "find ~/.local/share/%s/storage -mindepth 1 -maxdepth 1 -type d" $.osid) | split "\n" }}
{{- range $index, $store := $storage }}
  {{- if and (ne $store ".") (ne $store "..") (ne $store "") }}
  {{- $dirs := output "bash" "-c" (printf "find %s -mindepth 1 -maxdepth 1 -type d" $store) | split "\n" }}
  {{- range $index, $dir := $dirs }}
    {{- if and (ne $dir ".") (ne $dir "..") (ne $dir "") -}} {{- "\n" }}
if [ -d "{{- $dir -}}" ]; then
    TARGET="/{{- includeTemplate (printf "%s/storage/%s" $.osid ($store | base)) . -}}/{{- if eq ($dir | base) "Downloads" -}}Download{{- else -}}{{- $dir | base -}}{{- end -}}"
    if [ ! -d "$TARGET" ]; then
        mkdir -p "$TARGET"
    fi

    if [ -d "$TARGET" ]; then
        shopt -s nullglob
        for FILE in "{{- $dir -}}/"* "{{- $dir -}}/."*; do
            if [[ "$FILE" == "{{- $dir -}}/." || "$FILE" == "{{- $dir -}}/.." ]]; then
                continue
            fi

            TARGET_FILE="$TARGET/$(basename "$FILE")"
            if [ -f "$TARGET_FILE" ]; then
                cmp -s "$FILE" "$TARGET_FILE" || cp -r "$FILE" "$TARGET"
            else
                cp -r "$FILE" "$TARGET"
            fi
        done
        find "$TARGET" -type f -name ".keep" -exec rm -f {} +
    fi
fi
    {{- end }}
  {{- end }}
  {{- end }}
{{- end }}
{{- end -}}
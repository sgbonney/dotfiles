{{- /* -*- mode: emacs-lisp -*- */ -}}

(use-package emacs
  :ensure nil
  :custom
  (warning-minimum-level :emergency)
  (inhibit-startup-screen t)
  (initial-major-mode 'fundamental-mode)
  (initial-scratch-message nil)
  (server-client-instructions nil)
  (make-backup-files nil)

  {{ if contains "android" .osid -}}
  :bind
  ("<f9>" . toggle-based-on-text-conversion-default)

  :hook
  (after-change-major-mode . record-text-conversion-default)

  {{ end -}}
  :init
  (setq custom-file (concat user-emacs-directory "custom.el"))
  (load custom-file 'noerror)
  (setq custom-safe-themes t)

  {{ if contains "android" .osid -}}
  (setq touch-screen-display-keyboard t)

  (defvar-local text-conversion-default nil)

  (defun record-text-conversion-default ()
    (setq text-conversion-default text-conversion-style))

  (defun toggle-based-on-text-conversion-default ()
    (interactive)
    (if text-conversion-default
        (if text-conversion-style
            (progn
              (setq-local text-conversion-style nil)
              (when (fboundp 'set-text-conversion-style)
                (set-text-conversion-style nil))
              (when (fboundp 'god-local-mode)
                (god-local-mode 1)))
          (setq-local text-conversion-style t)
          (when (fboundp 'set-text-conversion-style)
            (set-text-conversion-style t))
          (when (fboundp 'god-local-mode)
            (god-local-mode -1)))
      (when (fboundp 'god-local-mode)
        (god-local-mode (if god-local-mode -1 1)))))

  {{ end -}}

  :config
  (require-theme 'modus-themes)
  (setq modus-themes-italic-constructs t
        modus-themes-bold-constructs t
        modus-themes-mixed-fonts t
  {{- if contains "android" .osid }}
        modus-themes-to-toggle '(modus-operandi-tinted modus-vivendi-tinted))
  (load-theme 'modus-vivendi-tinted :no-confirm)
  {{- else -}})
  {{- end }}

  (global-visual-line-mode 1)
  {{- if contains "android" .osid }}

  (defun android-emacs-background-service-file ()
    (interactive)
    (let ((file-name "Emacs Background Service"))
      (when (file-exists-p file-name)
	(delete-file file-name))
      (find-file file-name)
      (insert "This file is produced to keep Emacs running while it is in the background. Used in conjunction with Android 'Emacs Background Service' notification, see (emacs)Android Environment.")
      (read-only-mode)
      (bury-buffer)))
  (android-emacs-background-service-file)
  {{- end -}})

(use-package server
  :ensure nil
  :config
  (unless (server-running-p)
    (server-start)))

(use-package use-package
  :ensure nil
  :custom
  (use-package-always-ensure t)
  (package-native-compile t))

(use-package dired
  :ensure nil
  :hook
  (dired-mode . dired-hide-details-mode))

(use-package bicycle
  :after outline
  :bind (:map outline-minor-mode-map
	      ("TAB" . bicycle-cycle)
	      ("<tab>" . bicycle-cycle)
	      ("S-TAB" . bicycle-cycle-global)
	      ("<backtab>" . bicycle-cycle-global)))

(use-package prog-mode
  :ensure nil
  :config
  (add-hook 'prog-mode-hook 'outline-minor-mode)
  (add-hook 'prog-mode-hook 'hs-minor-mode))

(use-package outline-minor-faces
  :after outline
  :config (add-hook 'outline-minor-mode-hook
                    #'outline-minor-faces-mode))

(use-package backline
  :after outline
  :config (advice-add 'outline-flag-region :after 'backline-update))

{{ if contains "fedora" .osid -}}
(use-package auto-dark
  :config
  (ignore-errors
    (setq auto-dark-themes '((modus-operandi-tinted) (modus-vivendi-tinted)))
    (add-hook 'auto-dark-dark-mode-hook
	      (lambda ()
		(load-theme 'modus-vivendi-tinted :no-confirm)))
    (add-hook 'auto-dark-light-mode-hook
	      (lambda ()
		(load-theme 'modus-operandi-tinted :no-confirm)))
    (auto-dark-mode 1)))
{{ end -}}

(use-package god-mode
  :bind
  ({{- if contains "fedora" .osid -}}
   ("<f9>" . god-local-mode)
   {{ end -}}
   ("C-x C-1" . delete-other-windows)
   ("C-x C-2" . split-window-below)
   ("C-x C-3" . split-window-right)
   ("C-x C-0" . delete-window)
   :map god-local-mode-map
   ("z" . repeat)
   ("[" . backward-paragraph)
   ("]" . forward-paragraph))

  :hook
  (post-command . my-god-mode-update-cursor)
  (post-command . my-god-mode-update-mode-line)

  :init
  (setq god-mode-enable-function-key-translation nil)

  :config
  (defun my-god-mode-update-cursor ()
    (setq cursor-type (if (or god-local-mode buffer-read-only) 'box 'bar))
    (if (or god-local-mode)
        (blink-cursor-mode -1)
      (blink-cursor-mode 1)))

  (defun my-god-mode-update-mode-line ()
    (cond
     (god-local-mode
      (set-face-attribute 'mode-line nil
                          :foreground "#604000"
                          :background "#fff29a")
      (set-face-attribute 'mode-line-inactive nil
                          :foreground "#3f3000"
                          :background "#fff3da"))
     (t
      (set-face-attribute 'mode-line nil
                          :foreground "#0a0a0a"
                          :background "#d7d7d7")
      (set-face-attribute 'mode-line-inactive nil
                          :foreground "#404148"
                          :background "#efefef")))))

(use-package devil
  :init
  (global-devil-mode)

  :config
  (setq devil-all-keys-repeatable t))

(use-package org
  :custom
  (org-log-done 'time)
  (org-log-into-drawer t)

  (org-todo-keywords
   '((sequence "ACTIVITY(a)" "NEXT(n)" "PROJECT(p)" "SOMEDAY(s)" "WAITING(w)" "|" "DONE(d)" "CANCELLED(c)")))

  (org-agenda-files nil)
  (org-agenda-prefix-format '((agenda . " %i %?-12t% s")
                              (timeline . "  % s")
                              (todo . " %i %-12:c")
                              (tags . " %i %-12:c")
                              (search . " %i %-12:c")))

  (org-capture-templates
   '(("b" "Bibliographic")
     ("bw" "Website" entry
      (file "{{- template "find" "**/20240316T110159--*" -}}")
      "%(yas-expand-snippet-to-string (yas-lookup-snippet-by-uuid \"20251104T160623\" 'org-mode))"
      :empty-lines 1
      :after-finalize (lambda ()
                       (with-current-buffer (org-capture-get :buffer)
                         (org-bibtex "{{- template "find" "**/20251104T145004--*" -}}"))))
     ("f" "Fuel log" entry
      (file+headline "{{- template "find" "**/20190317T144500--*" -}}" "2025-26")
      "%(yas-expand-snippet-to-string (yas-lookup-snippet-by-uuid \"20251030T105223\" 'org-mode))"
      :empty-lines 1
      :before-finalize (lambda ()
                        (with-current-buffer (org-capture-get :buffer)
                          (org-update-all-dblocks))))
     ("w" "Work schedule" entry
      (file+headline "{{- template "find" "**/20241008T004852--*" -}}" "Employment")
      "%(yas-expand-snippet-to-string (yas-lookup-snippet-by-uuid \"20251103T081423\" 'org-mode))"
      :empty-lines 1)))

  (org-plantuml-jar-path
   (expand-file-name "{{- if contains "android" .osid -}}{{- "/data/data/com.termux/files/usr/share/java/plantuml.jar" | trim -}}{{- else if contains "fedora" .osid -}}{{- output "bash" "-c" "find /home/linuxbrew/.linuxbrew/ -name 'plantuml.jar'" | trim -}}{{- end -}}"))

  :bind (("C-c a" . org-agenda)
	 ("C-c c" . org-capture)
	 :map org-mode-map
              ("C-'" . nil)
	      ("C-," . nil))

  :config
  (add-to-list 'org-modules 'org-habit t)

  (defun refresh-org-agenda-files ()
    (interactive)
    (setq org-agenda-files
          (directory-files-recursively
           "~/Documents"
           ".*_agenda.*\\.org$"))
    (message "Org agenda files refreshed."))
  (refresh-org-agenda-files)

  (defun my/denote-archive-location (location)
    (if (string-match "^denote:\\([0-9]\\{8\\}T[0-9]\\{6\\}\\)::" location)
	(let* ((denote-id (match-string 1 location))
	       (heading-fmt (substring location (match-end 0)))
	       (archive-file (denote-get-path-by-id denote-id)))
	  (cons
	   (or archive-file
	       (error "No Denote file found with ID: %s" denote-id))
	   (format heading-fmt "")))
      (let ((current-file (buffer-file-name (buffer-base-buffer)))
	    (file-fmt (substring location 0 (string-match "::" location)))
	    (heading-fmt (substring location (match-end 0))))
	(cons
	 (if (org-string-nw-p file-fmt)
	     (expand-file-name
	      (format file-fmt (file-name-nondirectory current-file)))
	   current-file)
	 (format heading-fmt (file-name-nondirectory current-file))))))
  (advice-add 'org-archive--compute-location :override #'my/denote-archive-location)


  (defun org-columns-dblock-write-relative-links (ipos table params)
    (let ((link (plist-get params :link))
	  (width-specs
	   (mapcar (lambda (spec) (nth 2 spec))
		   org-columns-current-fmt-compiled)))
      (when table
	(let ((item-index
	       (let ((p (assoc "ITEM" org-columns-current-fmt-compiled)))
		 (and p (cl-position p
				     org-columns-current-fmt-compiled
				     :test #'equal))))
	      (hlines (plist-get params :hlines))
	      (indent (plist-get params :indent))
	      new-table)
	  (push (pop table) new-table)
	  (push (pop table) new-table)
	  (dolist (row table (setq table (nreverse new-table)))
	    (let ((level (car row)))
	      (when (and (not (eq (car new-table) 'hline))
			 (or (eq hlines t)
			     (and (numberp hlines) (<= level hlines))))
		(push 'hline new-table))
	      (when item-index
		(let* ((raw (nth item-index (cdr row)))
		       (cleaned (org-columns--clean-item raw))
		       (item (if (not link) cleaned
			       (let ((search (org-link-heading-search-string raw))
				     (file-path (buffer-file-name)))
				 (org-link-make-string
				  (if (not file-path) search
				    (format "file:%s::%s"
					    (file-relative-name file-path)
					    search))
				  cleaned)))))
		  (setf (nth item-index (cdr row))
			(if (and indent (> level 1))
			    (concat "\\_" (make-string (* 2 (1- level)) ?\s) item)
			  item))))
	      (push (cdr row) new-table))))
	(when (plist-get params :vlines)
	  (setq table
		(let ((size (length org-columns-current-fmt-compiled)))
		  (append (mapcar (lambda (x) (if (eq 'hline x) x (cons "" x)))
				  table)
			  (list (cons "/" (make-list size "<>")))))))
	(when (seq-find #'identity width-specs)
	  (push (mapcar (lambda (width) (when width (format "<%d>" width))) width-specs) table))
	(goto-char ipos)
	(let ((content-lines (org-split-string (plist-get params :content) "\n"))
	      recalc)
	  (when content-lines
	    (while (string-match-p "\\`[ \t]*#\\+" (car content-lines))
	      (insert (string-trim-left (pop content-lines)) "\n")))
	  (save-excursion
	    (insert
	     (mapconcat (lambda (row)
			  (if (eq row 'hline) "|-|"
			    (format "|%s|" (mapconcat #'identity row "|"))))
			table
			"\n"))
	    (let ((case-fold-search t))
	      (dolist (line content-lines)
		(when (string-match-p "\\`[ \t]*#\\+TBLFM:" line)
		  (insert "\n" (string-trim-left line))
		  (unless recalc (setq recalc t))))))
	  (when recalc (org-table-recalculate 'all t))
	  (org-table-align)
	  (when (seq-find #'identity width-specs)
	    (org-table-shrink))))))
  (setq org-columns-dblock-formatter #'org-columns-dblock-write-relative-links)

  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (plantuml . t)
     (python . t)
     (shell . t))))

(use-package org-web-tools
  :after org)

(use-package avy
  :bind (("C-:" . avy-goto-char)
	 ("C-'" . avy-goto-char-2)
	 ("M-g s" . avy-goto-char-timer)
	 ("M-g f" . avy-goto-line)
	 ("M-g w" . avy-goto-word-1)))

(use-package hide-mode-line
  :config
  (add-hook 'completion-list-mode-hook #'hide-mode-line-mode)
  (add-hook 'nov-mode-hook #'hide-mode-line-mode))

(use-package magit)

(use-package yasnippet
  :config
  (yas-global-mode t)
  (setq yas-snippet-dirs
        '("{{- template "find" "*/custom-snippets" -}}"))

  (defun yas-expand-snippet-to-string (template-or-lookup)
    (when template-or-lookup
      (with-temp-buffer
	(yas-minor-mode 1)
	(yas-expand-snippet template-or-lookup)
	(buffer-string))))

  (defun yas-lookup-snippet-by-uuid (uuid &optional mode noerror)
    (let ((template
	   (if mode
	       (when-let ((table (gethash mode yas--tables)))
		 (gethash uuid (yas--table-uuidhash table)))
	     (let ((result nil))
	       (maphash (lambda (_mode table)
			  (when-let ((tmpl (gethash uuid (yas--table-uuidhash table))))
			    (setq result tmpl)))
			yas--tables)
	       result))))
      (or template
	  (unless noerror
	    (error "No snippet with uuid: %s%s" uuid
		   (if mode (format " in mode: %s" mode) ""))))))

  (yas-reload-all))

(use-package el-patch)

(use-package vertico
  :init
  (vertico-mode)

  ;; Different scroll margin
  ;; (setq vertico-scroll-margin 0)

  ;; Show more candidates
  ;; (setq vertico-count 20)

  ;; Grow and shrink the Vertico minibuffer
  (setq vertico-resize t)

  ;; Optionally enable cycling for `vertico-next' and `vertico-previous'.
  (setq vertico-cycle t))

;; Persist history over Emacs restarts. Vertico sorts by history position.
(use-package savehist
  :ensure nil
  :init
  (savehist-mode))

(use-package marginalia
  :after vertico
  :bind
  (:map minibuffer-local-map
   ("M-A" . marginalia-cycle))
  :config
  (marginalia-mode))

(use-package orderless
  :custom
  (completion-styles '(orderless basic))
  (completion-category-overrides '((file (styles basic partial-completion)))))


(use-package denote
  :custom
  (denote-directory "~/Documents")

  :hook
  (dired-mode . denote-dired-mode))

(use-package denote-journal
  :after denote
  :custom
  (denote-journal-directory (expand-file-name "journal" denote-directory))
  (denote-journal-keyword "journal")
  (denote-journal-title-format 'day-date-month-year))

(use-package consult)

(use-package consult-notes
  :commands (consult-notes
             consult-notes-search-in-all-notes
             consult-notes-org-roam-find-node
             consult-notes-org-roam-find-node-relation)

  :preface
  (defun consult-notes-filtered ()
    (interactive)
    (let ((denote-excluded-files-regexp "_archive\\(_\\|\\.\\)"))
      (call-interactively #'consult-notes)))

  :bind (("C-c n a" . consult-notes)
         ("C-c n f" . consult-notes-filtered))

  :config
  (when (locate-library "denote")
    (consult-notes-denote-mode)))

(use-package dictionary
  :bind
  ("M-#" . dictionary-lookup-definition))

(use-package biblio)

(use-package citar
  :defer t
  :custom
  (citar-bibliography '("{{- template "find" "**/20251008T085257--*" -}}"
			"{{- template "find" "**/20251107T112447--*" -}}"
			"{{- template "find" "**/20251104T145004--*" -}}"
			"{{- template "find" "**/20251107T113324--*" -}}"))

  :bind
  (("C-c w b o" . citar-open))

  :config
  (setq citar-file-additional-files-separator "__")
  (setq citar-library-paths
        '("~/Audiobooks" "~/Ebooks" {{- if contains "android" .osid }} "~/Audiobooks/.placeholders" "~/Ebooks/.placeholders"{{- end -}}))
  (setq citar-templates
        '((main . "${title:48}     ${author editor:30%sn}     ${date year issued:4}")
          (suffix . "          ${=key= id:15}    ${=type=:12}    ${tags keywords:*}")
          (preview . "${author editor:%etal} (${year issued date}) ${title}, ${journal journaltitle publisher container-title collection-title}.\n")
          (note . "Notes on ${author editor:%etal}, ${title}"))))

(use-package citar-denote
  :custom
  (citar-open-always-create-notes t)

  :bind
  (("C-c w b c" . citar-create-note)
   ("C-c w b n" . citar-denote-open-note)
   ("C-c w b x" . citar-denote-nocite)
   :map org-mode-map
   ("C-c w b k" . citar-denote-add-citekey)
   ("C-c w b K" . citar-denote-remove-citekey)
   ("C-c w b d" . citar-denote-dwim)
   ("C-c w b e" . citar-denote-open-reference-entry))

  :init
  (citar-denote-mode))

(use-package emms
  :custom
  (emms-player-list '(emms-player-mpv))
  (emms-player-mpv-update-metadata t)
  (emms-repeat-playlist t)

  :bind-keymap
  (("C-c r" . emms-playlist-mode-map))

  :init
  (emms-standard)

  :config
  (emms-playing-time-disable-display)
  (emms-add-m3u-playlist "{{- template "find" "*/Transistor/**/collection.m3u" -}}"))

(use-package titlecase
  :defer t)

(use-package jinx
  :hook (emacs-startup . global-jinx-mode)
  :bind (("M-$" . jinx-correct)
         ("C-M-$" . jinx-languages)))

(use-package nov
  {{ if contains "android" .osid -}}
  :bind (("<volume-up>" . nov-scroll-down)
         ("<volume-down>" . nov-scroll-up))

  {{ end -}}
  :hook ((nov-mode . (lambda ()
                       (display-line-numbers-mode -1)))
         (nov-mode-hook . (lambda ()
                            (make-local-variable 'my-line-numbers-enabled)
                            (setq my-line-numbers-enabled nil))))

  :init
  (add-to-list 'auto-mode-alist '("\\.epub\\'" . nov-mode))

  :config
  (display-line-numbers-mode 0))

(use-package f)

(defun my/extract-pins-from-org ()
  "Extract pins from the specified Org file and display them in a temporary buffer."
  (interactive)
  (let ((org-file-path "{{- template "find" "**/20240808T080919--*" -}}"))  ;; Specify your Org file path here
    (if (file-exists-p org-file-path)
        (progn
          (org-babel-load-file org-file-path)
          (message "Pins extracted successfully."))
      (error "Org file not found: %s" org-file-path))))

(defun org-fetch-xcweather-forecast ()
  "Fetch XCWeather forecast for the postcode found in the Org heading at point."
  (interactive)
  (when (org-at-heading-p)
    (let* ((heading (org-get-heading t t t t))
           (postcode (org-entry-get (point) "POSTCODE")))
      (if postcode
          (progn
            (setq postcode (downcase postcode))  ;; Make postcode lowercase
            (let ((url (concat "https://www.xcweather.co.uk/forecast/" (replace-regexp-in-string " " "_" postcode))))
              (message "Fetching XCWeather forecast for postcode: %s" postcode)
              (browse-url url)))  ;; Open the URL in the browser
        (message "No postcode found in the properties.")))))

(defun keepassxc ()
  (interactive)
  {{ if contains "android" .osid -}}
  (let ((command "am startservice --user 0 -n com.termux/com.termux.app.RunCommandService \
-a com.termux.RUN_COMMAND \
--es com.termux.RUN_COMMAND_PATH '{{- template "find" "**/bin/keepassxc.sh" -}}' \
--esa com.termux.RUN_COMMAND_ARGUMENTS '' \
--es com.termux.RUN_COMMAND_WORKDIR '{{- .chezmoi.homeDir -}}' \
--ez com.termux.RUN_COMMAND_BACKGROUND 'true' \
--es com.termux.RUN_COMMAND_SESSION_ACTION '0'"))
    (shell-command command))

  {{- else if contains "linux" .osid -}}
  (shell-command "{{- template "find" "**/bin/keepassxc.sh" -}}")
  {{- end -}})

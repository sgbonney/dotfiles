{{- /* -*- mode: emacs-lisp; outline-default-state: 2; eval: (outline-minor-mode 1); -*- */ -}}

;;; init.el --- Init -*- lexical-binding: t; -*-

;;;; Packages

(use-package package
  :ensure nil
  :preface
  (defun update-gpg-keyring ()
    "Update GPG keys for package verification."
    (interactive)
    (let ((original-value package-check-signature))
      (unwind-protect
          (progn
            (setq package-check-signature nil)
            (message "Signature verification disabled temporarily...")
            (condition-case err
                (progn
                  (package-install 'gnu-elpa-keyring-update)
                  (message "Keyring update installed successfully"))
              (error
               (message "Failed to install keyring update: %s" (error-message-string err))))
            (setq package-check-signature 'allow-unsigned)
            (message "Signature verification re-enabled (allow-unsigned)"))
        (setq package-check-signature original-value)))))

(use-package use-package
  :ensure nil
  :custom
  (use-package-always-ensure t)

  (package-native-compile t))

(use-package emacs
  :ensure nil
  :custom
  (warning-minimum-level :emergency)
  (inhibit-startup-screen t)
  (initial-major-mode 'fundamental-mode)
  (initial-scratch-message nil)
  (server-client-instructions nil)
  (make-backup-files nil)

  :init
  (setq confirm-kill-processes nil)
  (setq auto-save-list-file-prefix nil)

  (setq custom-file (concat user-emacs-directory "custom.el"))
  (load custom-file 'noerror)
  (setq custom-safe-themes t)

  {{ if contains "android" .osid -}}
  (setq touch-screen-display-keyboard t)

  (defvar-local text-conversion-default nil)

  (defun text-conversion-save-and-disable ()
    (setq text-conversion-default text-conversion-style)
    (when (fboundp 'set-text-conversion-style)
      (set-text-conversion-style nil)))

  (defun text-conversion-restore-default ()
    (when (and text-conversion-default
               (fboundp 'set-text-conversion-style))
      (set-text-conversion-style text-conversion-default)))

  (setenv "PATH" (concat (getenv "PATH") ":/data/data/com.termux/files/usr/bin/texlive"))
  (setenv "TEXMFROOT" "/data/data/com.termux/files/usr/share/texlive/2025")
  (setenv "TEXMFLOCAL" "/data/data/com.termux/files/usr/share/texlive/texmf-local")
  (setenv "OSFONTDIR" "/data/data/com.termux/files/usr/share/fonts/TTF")
  (setenv "TRFONTS" "/data/data/com.termux/files/usr/share/groff/{current/font,site-font}/devps")
  {{ end -}}

  :config
  (require-theme 'modus-themes)
  (setq modus-themes-italic-constructs t
        modus-themes-bold-constructs t
        modus-themes-mixed-fonts t
  {{- if contains "android" .osid }}
        modus-themes-to-toggle '(modus-operandi-tinted modus-vivendi-tinted))
  (load-theme 'modus-vivendi-tinted :no-confirm)
  {{- else -}})
  {{- end }}

  (global-visual-line-mode 1)

  (auto-save-visited-mode 1)
  {{- if contains "android" .osid }}

  (defun android-emacs-background-service-file ()
    (interactive)
    (let ((file-name "Emacs Background Service"))
      (when (file-exists-p file-name)
	(delete-file file-name))
      (find-file file-name)
      (insert "This file is produced to keep Emacs running while it is in the background. Used in conjunction with Android 'Emacs Background Service' notification, see (emacs)Android Environment.")
      (setq-local auto-save-visited-mode nil)
      (read-only-mode)
      (bury-buffer)))
  (android-emacs-background-service-file)
  {{- end -}})

{{ if contains "linux" .osid -}}
(use-package auto-dark
  :custom
  (auto-dark-themes '((modus-vivendi-tinted) (modus-operandi-tinted)))
  :init
  (auto-dark-mode))

{{ end -}}
(use-package server
  :ensure nil
  :config
  (unless (server-running-p)
    (server-start)))

(use-package autorevert
  :ensure nil
  :config
  (global-auto-revert-mode 1))

(use-package dired
  :ensure nil
  :hook
  (dired-mode . dired-hide-details-mode))

(use-package prog-mode
  :ensure nil
  :config
  (add-hook 'prog-mode-hook 'outline-minor-mode)
  (add-hook 'prog-mode-hook 'hs-minor-mode))

(use-package outline
  :ensure nil
  :config
  (add-to-list 'safe-local-variable-values
               '(outline-default-state . 2)))

(use-package bicycle
  :after outline
  :bind (:map outline-minor-mode-map
	      ("TAB" . bicycle-cycle)
	      ("<tab>" . bicycle-cycle)
	      ("S-TAB" . bicycle-cycle-global)
	      ("<backtab>" . bicycle-cycle-global)))

(use-package outline-minor-faces
  :after outline
  :config (add-hook 'outline-minor-mode-hook
                    #'outline-minor-faces-mode))

(use-package backline
  :after outline
  :config (advice-add 'outline-flag-region :after 'backline-update))

(use-package god-mode
  :bind
  (("<f9>" . god-local-mode)
   :map god-local-mode-map
   ("z" . repeat)
   ("[" . backward-paragraph)
   ("]" . forward-paragraph))

  :hook
  {{ if contains "android" .osid -}}
  (god-mode-enabled . text-conversion-save-and-disable)
  (god-mode-disabled . text-conversion-restore-default)

  {{ end -}}
  (post-command . my-god-mode-update-cursor)
  (post-command . my-god-mode-update-mode-line)

  :init
  (setq god-mode-enable-function-key-translation nil)

  :config
  (god-mode-all)

  (defun my-god-mode-update-cursor ()
    (setq cursor-type (if (or god-local-mode buffer-read-only) 'box 'bar))
    (if (or god-local-mode)
        (blink-cursor-mode -1)
      (blink-cursor-mode 1)))

  (defun my-god-mode-update-mode-line ()
    (cond
     (god-local-mode
      (set-face-attribute 'mode-line nil
                          :foreground "#604000"
                          :background "#fff29a")
      (set-face-attribute 'mode-line-inactive nil
                          :foreground "#3f3000"
                          :background "#fff3da"))
     (t
      (set-face-attribute 'mode-line nil
                          :foreground "#0a0a0a"
                          :background "#d7d7d7")
      (set-face-attribute 'mode-line-inactive nil
                          :foreground "#404148"
                          :background "#efefef")))))

(use-package god-mode-isearch
  :ensure nil
  :after (god-mode isearch)
  :bind (:map isearch-mode-map
              ("<f9>" . god-mode-isearch-activate)
         :map god-mode-isearch-map
              ("<f9>" . god-mode-isearch-disable)))

(use-package which-key
  :ensure nil
  :after god-mode
  :config
  (which-key-mode 1)
  (which-key-enable-god-mode-support))

(use-package org
  :demand t
  :custom
  (org-log-into-drawer t)

  (org-todo-keywords
   '((sequence "ACTIVITY(a)" "NEXT(n)" "PROJECT(p)" "SOMEDAY(s)" "WAITING(w)" "|" "DONE(d)" "CANCELLED(c)")))

  (org-agenda-files nil)
  (org-agenda-hide-tags-regexp "agenda")
  (org-agenda-prefix-format '((agenda . " %i %?-12t% s")
                              (timeline . "  % s")
                              (todo . " %i %-12:c")
                              (tags . " %i %-12:c")
                              (search . " %i %-12:c")))

  (org-capture-templates
   '(("b" "Bibliographic")
     ("bw" "Website" entry
      (file "{{- template "find" "**/20240316T110159--*" -}}")
      "%(yas-expand-snippet-to-string (yas-lookup-snippet-by-uuid \"20251104T160623\" 'org-mode))"
      :empty-lines 1
      :after-finalize (lambda ()
                       (with-current-buffer (org-capture-get :buffer)
                         (org-bibtex "{{- template "find" "**/20251104T145004--*" -}}"))))
     ("f" "Fuel log" entry
      (file+headline "{{- template "find" "**/20190317T144500--*" -}}" "2025-26")
      "%(yas-expand-snippet-to-string (yas-lookup-snippet-by-uuid \"20251030T105223\" 'org-mode))"
      :empty-lines 1
      :before-finalize (lambda ()
                        (with-current-buffer (org-capture-get :buffer)
                          (org-update-all-dblocks))))
     ("w" "Work schedule" entry
      (file+headline "{{- template "find" "**/20241008T004852--*" -}}" "Employment")
      "%(yas-expand-snippet-to-string (yas-lookup-snippet-by-uuid \"20251103T081423\" 'org-mode))"
      :empty-lines 1)))

  (org-cite-global-bibliography
   '("{{- template "find" "**/20251008T085257--*" -}}"
     "{{- template "find" "**/20251104T145004--*" -}}"
     "{{- template "find" "**/20251107T112447--*" -}}"
     "{{- template "find" "**/20251107T113324--*" -}}"))

  (org-plantuml-jar-path "{{- if contains "android" .osid -}}{{- "/data/data/com.termux/files/usr/share/java/plantuml.jar" | trim -}}{{- else if contains "linux" .osid -}}{{- output "bash" "-c" "find /home/linuxbrew/.linuxbrew/ -name 'plantuml.jar'" | trim -}}{{- end -}}")

  :bind (("C-c a" . org-agenda)
	 ("C-c c" . org-capture)
	 :map org-mode-map
              ("C-'" . nil)
	      ("C-," . nil))

  :config
  (add-to-list 'org-modules 'org-habit t)

  (add-to-list 'safe-local-variable-values
               '(org-duration-format . h:mm))
  (add-to-list 'safe-local-variable-values
               '(org-log-done . time))

  (defun refresh-org-agenda-files ()
    (interactive)
    (setq org-agenda-files
          (directory-files-recursively
           "{{- .chezmoi.homeDir -}}/Documents"
           ".*_agenda.*\\.org$"))
    (org-agenda-prepare-buffers org-agenda-files)
    (message "Org agenda files refreshed."))
  (refresh-org-agenda-files)

  (defun my/denote-archive-location (location)
    (if (string-match "^denote:\\([0-9]\\{8\\}T[0-9]\\{6\\}\\)::" location)
	(let* ((denote-id (match-string 1 location))
	       (heading-fmt (substring location (match-end 0)))
	       (archive-file (denote-get-path-by-id denote-id)))
	  (cons
	   (or archive-file
	       (error "No Denote file found with ID: %s" denote-id))
	   (format heading-fmt "")))
      (let ((current-file (buffer-file-name (buffer-base-buffer)))
	    (file-fmt (substring location 0 (string-match "::" location)))
	    (heading-fmt (substring location (match-end 0))))
	(cons
	 (if (org-string-nw-p file-fmt)
	     (expand-file-name
	      (format file-fmt (file-name-nondirectory current-file)))
	   current-file)
	 (format heading-fmt (file-name-nondirectory current-file))))))
  (advice-add 'org-archive--compute-location :override #'my/denote-archive-location)


  (defun org-columns-dblock-write-relative-links (ipos table params)
    (let ((link (plist-get params :link))
	  (width-specs
	   (mapcar (lambda (spec) (nth 2 spec))
		   org-columns-current-fmt-compiled)))
      (when table
	(let ((item-index
	       (let ((p (assoc "ITEM" org-columns-current-fmt-compiled)))
		 (and p (cl-position p
				     org-columns-current-fmt-compiled
				     :test #'equal))))
	      (hlines (plist-get params :hlines))
	      (indent (plist-get params :indent))
	      new-table)
	  (push (pop table) new-table)
	  (push (pop table) new-table)
	  (dolist (row table (setq table (nreverse new-table)))
	    (let ((level (car row)))
	      (when (and (not (eq (car new-table) 'hline))
			 (or (eq hlines t)
			     (and (numberp hlines) (<= level hlines))))
		(push 'hline new-table))
	      (when item-index
		(let* ((raw (nth item-index (cdr row)))
		       (cleaned (org-columns--clean-item raw))
		       (item (if (not link) cleaned
			       (let ((search (org-link-heading-search-string raw))
				     (file-path (buffer-file-name)))
				 (org-link-make-string
				  (if (not file-path) search
				    (format "file:%s::%s"
					    (file-relative-name file-path)
					    search))
				  cleaned)))))
		  (setf (nth item-index (cdr row))
			(if (and indent (> level 1))
			    (concat "\\_" (make-string (* 2 (1- level)) ?\s) item)
			  item))))
	      (push (cdr row) new-table))))
	(when (plist-get params :vlines)
	  (setq table
		(let ((size (length org-columns-current-fmt-compiled)))
		  (append (mapcar (lambda (x) (if (eq 'hline x) x (cons "" x)))
				  table)
			  (list (cons "/" (make-list size "<>")))))))
	(when (seq-find #'identity width-specs)
	  (push (mapcar (lambda (width) (when width (format "<%d>" width))) width-specs) table))
	(goto-char ipos)
	(let ((content-lines (org-split-string (plist-get params :content) "\n"))
	      recalc)
	  (when content-lines
	    (while (string-match-p "\\`[ \t]*#\\+" (car content-lines))
	      (insert (string-trim-left (pop content-lines)) "\n")))
	  (save-excursion
	    (insert
	     (mapconcat (lambda (row)
			  (if (eq row 'hline) "|-|"
			    (format "|%s|" (mapconcat #'identity row "|"))))
			table
			"\n"))
	    (let ((case-fold-search t))
	      (dolist (line content-lines)
		(when (string-match-p "\\`[ \t]*#\\+TBLFM:" line)
		  (insert "\n" (string-trim-left line))
		  (unless recalc (setq recalc t))))))
	  (when recalc (org-table-recalculate 'all t))
	  (org-table-align)
	  (when (seq-find #'identity width-specs)
	    (org-table-shrink))))))
  (setq org-columns-dblock-formatter #'org-columns-dblock-write-relative-links)

  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (plantuml . t)
     (python . t)
     (shell . t))))

(use-package org-transclusion
  :after org
  :hook (org-mode . org-transclusion-mode)
  :config
  (setq org-transclusion-add-all-on-activate t))

(use-package org-contrib)

(use-package org-web-tools
  :after org)

(use-package ox-latex
  :ensure nil
  :config
  (add-to-list 'org-latex-classes
               '("moderncv" "\\documentclass{moderncv}"
                 ("\\section{%s}" . "\\section*{%s}")
                 ("\\subsection{%s}" . "\\subsection*{%s}")
                 ("\\subsubsection{%s}" . "\\subsubsection*{%s}"))))

(use-package ox-extra
  :ensure nil
  :after org-contrib
  :config
  (ox-extras-activate '(ignore-headlines)))

(use-package markdown-mode
  :bind (:map markdown-mode-map
              ("C-c C-e" . markdown-do))

  :mode
  ("README\\.md\\'" . gfm-mode)

  :init
  (setq markdown-command "multimarkdown"))

(use-package plantuml-mode
  :custom
  (plantuml-jar-path org-plantuml-jar-path)
  (plantuml-default-exec-mode 'jar)

  :init
  (add-to-list 'auto-mode-alist '("\\.\\(plantuml\\|puml\\)\\'" . plantuml-mode))

  :config
  (setq plantuml-output-type "svg"))

(use-package csv-mode
  :hook
  ((csv-mode . (lambda () (visual-line-mode -1)))
   (csv-mode . csv-align-mode)))

(use-package vcard)

(use-package reftex
  :ensure nil
  :custom
  (reftex-default-bibliography org-cite-global-bibliography)

  :config
  (defadvice reftex-view-crossref (around auto-switch-to-latex activate)
    "Automatically switch to latex-mode if not already in a LaTeX mode."
    (if (memq major-mode '(latex-mode tex-mode))
        ad-do-it
      (let ((original-mode major-mode))
        (major-mode-suspend)
        (latex-mode)
        (unwind-protect
            ad-do-it
          (major-mode-restore (list original-mode)))))))

(use-package avy
  :ensure t
  :commands (avy-goto-char
             avy-goto-char-2
             avy-next)

  :init
  (global-set-key (kbd "C-'") 'avy-goto-char-2))

(use-package hide-mode-line
  :config
  (add-hook 'completion-list-mode-hook #'hide-mode-line-mode)
  (add-hook 'nov-mode-hook #'hide-mode-line-mode))

(use-package magit)

(use-package yasnippet
  :config
  (yas-global-mode t)
  (setq yas-snippet-dirs
        '("{{- template "find" "*/custom-snippets" -}}"))

  (defun yas-expand-snippet-to-string (template-or-lookup)
    (when template-or-lookup
      (with-temp-buffer
	(yas-minor-mode 1)
	(yas-expand-snippet template-or-lookup)
	(buffer-string))))

  (defun yas-lookup-snippet-by-uuid (uuid &optional mode noerror)
    (let ((template
	   (if mode
	       (when-let ((table (gethash mode yas--tables)))
		 (gethash uuid (yas--table-uuidhash table)))
	     (let ((result nil))
	       (maphash (lambda (_mode table)
			  (when-let ((tmpl (gethash uuid (yas--table-uuidhash table))))
			    (setq result tmpl)))
			yas--tables)
	       result))))
      (or template
	  (unless noerror
	    (error "No snippet with uuid: %s%s" uuid
		   (if mode (format " in mode: %s" mode) ""))))))

  (yas-reload-all))

(use-package el-patch)

(use-package vertico
  :config
  (vertico-mode))

(use-package savehist
  :ensure nil
  :init
  (savehist-mode))

(use-package orderless
  :custom
  (completion-styles '(orderless basic))
  (completion-category-defaults nil)
  (completion-category-overrides '((file (styles partial-completion)))))

(use-package marginalia
  :commands (marginalia-cycle)
  :hook (after-init . marginalia-mode))

(use-package embark
  :commands (embark-act
             embark-dwim
             embark-export
             embark-collect
             embark-bindings
             embark-prefix-help-command)

  :bind
  (("C-." . embark-act)
   ("C-;" . embark-dwim)
   ("C-h B" . embark-bindings))

  :init
  (setq prefix-help-command #'embark-prefix-help-command)

  :config
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none)))))

(use-package consult
  :bind (;; C-c bindings in `mode-specific-map'
         ("C-c M-x" . consult-mode-command)
         ("C-c h" . consult-history)
         ("C-c k" . consult-kmacro)
         ("C-c m" . consult-man)
         ("C-c i" . consult-info)
         ([remap Info-search] . consult-info)
         ;; C-x bindings in `ctl-x-map'
         ("C-x M-:" . consult-complex-command)
         ("C-x b" . consult-buffer)
         ("C-x 4 b" . consult-buffer-other-window)
         ("C-x 5 b" . consult-buffer-other-frame)
         ("C-x t b" . consult-buffer-other-tab)
         ("C-x r b" . consult-bookmark)
         ("C-x p b" . consult-project-buffer)
         ;; Custom M-# bindings for fast register access
         ("M-#" . consult-register-load)
         ("M-'" . consult-register-store)
         ("C-M-#" . consult-register)
         ;; Other custom bindings
         ("M-y" . consult-yank-pop)
         ;; M-g bindings in `goto-map'
         ("M-g e" . consult-compile-error)
         ("M-g f" . consult-flymake)
         ("M-g g" . consult-goto-line)
         ("M-g M-g" . consult-goto-line)
         ("M-g o" . consult-outline)
         ("M-g m" . consult-mark)
         ("M-g k" . consult-global-mark)
         ("M-g i" . consult-imenu)
         ("M-g I" . consult-imenu-multi)
         ;; M-s bindings in `search-map'
         ("M-s d" . consult-find)
         ("M-s c" . consult-locate)
         ("M-s g" . consult-grep)
         ("M-s G" . consult-git-grep)
         ("M-s r" . consult-ripgrep)
         ("M-s l" . consult-line)
         ("M-s L" . consult-line-multi)
         ("M-s k" . consult-keep-lines)
         ("M-s u" . consult-focus-lines)
         ;; Isearch integration
         ("M-s e" . consult-isearch-history)
         :map isearch-mode-map
         ("M-e" . consult-isearch-history)
         ("M-s e" . consult-isearch-history)
         ("M-s l" . consult-line)
         ("M-s L" . consult-line-multi)
         ;; Minibuffer history
         :map minibuffer-local-map
         ("M-s" . consult-history)
         ("M-r" . consult-history))

  :hook (completion-list-mode . consult-preview-at-point-mode)

  :init
  (setq register-preview-delay 0.5
        register-preview-function #'consult-register-format)

  (advice-add #'register-preview :override #'consult-register-window)

  (setq xref-show-xrefs-function #'consult-xref
        xref-show-definitions-function #'consult-xref)

  :config
  (consult-customize
   consult-theme :preview-key '(:debounce 0.2 any)
   consult-ripgrep consult-git-grep consult-grep
   consult-bookmark consult-recent-file consult-xref
   consult--source-bookmark consult--source-file-register
   consult--source-recent-file consult--source-project-recent-file
   ;; :preview-key "M-."
   :preview-key '(:debounce 0.4 any))
  (setq consult-narrow-key "<"))

(use-package embark-consult
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))

(use-package denote
  :custom
  (denote-directory "{{- .chezmoi.homeDir -}}/Documents")

  :hook
  (dired-mode . denote-dired-mode))

(use-package denote-org
  :after denote)

(use-package denote-journal
  :after denote
  :custom
  (denote-journal-directory (expand-file-name "journal" denote-directory))
  (denote-journal-keyword "journal")
  (denote-journal-title-format 'day-date-month-year))

(use-package consult-notes
  :commands (consult-notes
             consult-notes-search-in-all-notes)

  :preface
  (defvar denote-excluded-files-regexp)

  (defun consult-notes-filtered ()
    (interactive)
    (let ((denote-excluded-files-regexp "_archive\\(_\\|\\.\\)"))
      (call-interactively #'consult-notes)))

  :bind (("C-c n a" . consult-notes)
         ("C-c n f" . consult-notes-filtered))

  :config
  (when (locate-library "denote")
    (consult-notes-denote-mode)))

(use-package biblio)

(use-package citar
  :defer t
  :custom
  (citar-bibliography '("{{- template "find" "**/20251008T085257--*" -}}"
			"{{- template "find" "**/20251107T112447--*" -}}"
			"{{- template "find" "**/20251104T145004--*" -}}"
			"{{- template "find" "**/20251107T113324--*" -}}"))

  :bind
  (("C-c w b o" . citar-open))

  :config
  (setq citar-file-additional-files-separator "__")
  (setq citar-library-paths
        '("{{- .chezmoi.homeDir -}}/Audiobooks" "{{- .chezmoi.homeDir -}}/Ebooks" {{- if contains "android" .osid }} "{{- .chezmoi.homeDir -}}/Audiobooks/.placeholders" "{{- .chezmoi.homeDir -}}/Ebooks/.placeholders"{{- end -}}))
  (setq citar-templates
        '((main . "${title:48}     ${author editor:30%sn}     ${date year issued:4}")
          (suffix . "          ${=key= id:15}    ${=type=:12}    ${tags keywords:*}")
          (preview . "${author editor:%etal} (${year issued date}) ${title}, ${journal journaltitle publisher container-title collection-title}.\n")
          (note . "Notes on ${author editor:%etal}, ${title}"))))

(use-package citar-denote
  :after org
  :custom
  (citar-open-always-create-notes t)

  :bind
  (("C-c w b c" . citar-create-note)
   ("C-c w b n" . citar-denote-open-note)
   ("C-c w b x" . citar-denote-nocite)
   :map org-mode-map
   ("C-c w b k" . citar-denote-add-citekey)
   ("C-c w b K" . citar-denote-remove-citekey)
   ("C-c w b d" . citar-denote-dwim)
   ("C-c w b e" . citar-denote-open-reference-entry))

  :init
  (citar-denote-mode))

{{ if contains "fedora" .osid -}}
(use-package emms
  :custom
  (emms-player-list '(emms-player-mpv))
  (emms-player-mpv-update-metadata t)
  (emms-repeat-playlist t)

  :bind-keymap
  (("C-c r" . emms-playlist-mode-map))

  :config
  (emms-standard)
  (emms-playing-time-disable-display)
  (emms-add-m3u-playlist "{{- template "find" "*/Transistor/collection.m3u" -}}"))

{{ end -}}
(use-package titlecase
  :defer t)

(use-package jinx
  :hook (emacs-startup . global-jinx-mode)
  :bind (("M-$" . jinx-correct)
         ("C-M-$" . jinx-languages)))

(use-package nov
  {{ if contains "android" .osid -}}
  :bind (("<volume-up>" . nov-scroll-down)
         ("<volume-down>" . nov-scroll-up))

  {{ end -}}
  :hook ((nov-mode . (lambda ()
                       (display-line-numbers-mode -1)))
         (nov-mode-hook . (lambda ()
                            (make-local-variable 'my-line-numbers-enabled)
                            (setq my-line-numbers-enabled nil))))

  :init
  (add-to-list 'auto-mode-alist '("\\.epub\\'" . nov-mode))

  :config
  (display-line-numbers-mode 0))

(use-package f)

;;;; Functions

(defun my/extract-pins-from-org ()
  "Extract pins from the specified Org file and display them in a temporary buffer."
  (interactive)
  (let ((org-file-path "{{- template "find" "**/20240808T080919--*" -}}"))  ;; Specify your Org file path here
    (if (file-exists-p org-file-path)
        (progn
          (org-babel-load-file org-file-path)
          (message "Pins extracted successfully."))
      (error "Org file not found: %s" org-file-path))))

(defun org-fetch-xcweather-forecast ()
  "Fetch XCWeather forecast for the postcode found in the Org heading at point."
  (interactive)
  (when (org-at-heading-p)
    (let* ((heading (org-get-heading t t t t))
           (postcode (org-entry-get (point) "POSTCODE")))
      (if postcode
          (progn
            (setq postcode (downcase postcode))  ;; Make postcode lowercase
            (let ((url (concat "https://www.xcweather.co.uk/forecast/" (replace-regexp-in-string " " "_" postcode))))
              (message "Fetching XCWeather forecast for postcode: %s" postcode)
              (browse-url url)))  ;; Open the URL in the browser
        (message "No postcode found in the properties.")))))

;;;;; KeePass

(defun keepassxc ()
  (interactive)
  {{ if contains "android" .osid -}}
  (let ((command "am startservice --user 0 -n com.termux/com.termux.app.RunCommandService \
-a com.termux.RUN_COMMAND \
--es com.termux.RUN_COMMAND_PATH '{{- template "find" "**/bin/keepassxc.sh" -}}' \
--esa com.termux.RUN_COMMAND_ARGUMENTS '' \
--es com.termux.RUN_COMMAND_WORKDIR '{{- .chezmoi.homeDir -}}' \
--ez com.termux.RUN_COMMAND_BACKGROUND 'true' \
--es com.termux.RUN_COMMAND_SESSION_ACTION '0'"))
    (shell-command command))

  {{- else if contains "linux" .osid -}}
  (shell-command "{{- template "find" "**/bin/keepassxc.sh" -}}")
  {{- end -}})

(defun keepass-ssh-add ()
  (interactive)
  (let ((process-connection-type t))
    (comint-run "{{- template "find" "**/bin/keepass-ssh-add.sh" -}}")))
